<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î—è–∫—É—î–º–æ –∑–∞ –æ–ø–ª–∞—Ç—É! | Svitlana Tape</title>
    
    <!-- Meta Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '1548773689373078');
    fbq('track', 'PageView');
    fbq('track', 'Purchase', {currency: 'UAH', value: 390});
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=1548773689373078&ev=PageView&noscript=1"/></noscript>
    <!-- End Meta Pixel Code -->
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #0b0d12 0%, #1a1d26 100%);
            color: #ffffff;
            min-height: 100vh;
        }
        
        .success-card {
            background: linear-gradient(145deg, #13161c 0%, #0f1116 100%);
            border: 1px solid #2d323e;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        .success-icon {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            animation: pulse-green 2s infinite;
        }
        
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            50% { box-shadow: 0 0 0 20px rgba(16, 185, 129, 0); }
        }
        
        .telegram-btn {
            background: linear-gradient(135deg, #0088cc 0%, #0077b5 100%);
            transition: all 0.3s ease;
            animation: pulse-blue 2s infinite;
        }
        
        .telegram-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0, 136, 204, 0.4);
        }
        
        @keyframes pulse-blue {
            0%, 100% { box-shadow: 0 10px 30px rgba(0, 136, 204, 0.3); }
            50% { box-shadow: 0 10px 40px rgba(0, 136, 204, 0.5); }
        }
        
        .step-number {
            background: linear-gradient(135deg, #E13030 0%, #b91c1c 100%);
        }
        
        .loading-spinner {
            border: 3px solid #2d323e;
            border-top: 3px solid #0088cc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">
    
    <div class="success-card rounded-3xl p-8 md:p-12 max-w-lg w-full text-center">
        
        <!-- Success Icon -->
        <div class="success-icon w-20 h-20 md:w-24 md:h-24 rounded-full flex items-center justify-center mx-auto mb-6">
            <i class="fa-solid fa-check text-white text-3xl md:text-4xl"></i>
        </div>
        
        <!-- Title -->
        <h1 class="text-2xl md:text-3xl font-bold mb-4">
            –û–ø–ª–∞—Ç–∞ –ø—Ä–æ–π—à–ª–∞ —É—Å–ø—ñ—à–Ω–æ! üéâ
        </h1>
        
        <p class="text-gray-400 mb-8">
            –î—è–∫—É—î–º–æ –∑–∞ –¥–æ–≤—ñ—Ä—É! –¢–µ–ø–µ—Ä –ø–µ—Ä–µ–π–¥—ñ—Ç—å —É Telegram-–±–æ—Ç, —â–æ–± —Ä–æ–∑–ø–æ—á–∞—Ç–∏ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫—É.
        </p>
        
        <!-- Loading state -->
        <div id="loading-state" class="mb-8">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-400 text-sm">–ì–µ–Ω–µ—Ä—É—î–º–æ –≤–∞—à–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è...</p>
        </div>
        
        <!-- Bot Link (hidden initially) -->
        <div id="bot-link-container" class="hidden mb-8">
            <a id="bot-link" href="#" target="_blank" 
               class="telegram-btn inline-flex items-center justify-center gap-3 text-white text-lg font-bold py-4 px-8 rounded-full w-full">
                <i class="fa-brands fa-telegram text-2xl"></i>
                –ü–µ—Ä–µ–π—Ç–∏ –≤ Telegram-–±–æ—Ç
            </a>
        </div>
        
        <!-- Fallback link -->
        <div id="fallback-container" class="hidden mb-8">
            <p class="text-yellow-400 mb-4">
                <i class="fa-solid fa-exclamation-triangle mr-2"></i>
                –Ø–∫—â–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–µ –∑'—è–≤–∏–ª–æ—Å—è, –Ω–∞–ø–∏—à—ñ—Ç—å –Ω–∞–º:
            </p>
            <a href="https://t.me/testlid12bot" target="_blank" 
               class="telegram-btn inline-flex items-center justify-center gap-3 text-white text-lg font-bold py-4 px-8 rounded-full w-full">
                <i class="fa-brands fa-telegram text-2xl"></i>
                –ù–∞–ø–∏—Å–∞—Ç–∏ –≤ –±–æ—Ç
            </a>
        </div>
        
        <!-- Steps -->
        <div class="text-left space-y-4 mb-8">
            <h3 class="text-lg font-bold text-center mb-4">–©–æ –¥–∞–ª—ñ?</h3>
            
            <div class="flex items-start gap-4">
                <div class="step-number w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">1</div>
                <div>
                    <p class="text-gray-300">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –≤–∏—â–µ —ñ –ø–µ—Ä–µ–π–¥—ñ—Ç—å —É Telegram-–±–æ—Ç</p>
                </div>
            </div>
            
            <div class="flex items-start gap-4">
                <div class="step-number w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">2</div>
                <div>
                    <p class="text-gray-300">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–°—Ç–∞—Ä—Ç" —É –±–æ—Ç—ñ ‚Äî –≤–∞—à –¥–æ—Å—Ç—É–ø –∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</p>
                </div>
            </div>
            
            <div class="flex items-start gap-4">
                <div class="step-number w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">3</div>
                <div>
                    <p class="text-gray-300">–ù–∞–¥—ñ—à–ª—ñ—Ç—å —Ñ–æ—Ç–æ –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Ç–∞ –æ—Ç—Ä–∏–º–∞–π—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó!</p>
                </div>
            </div>
        </div>
        
        <!-- Support -->
        <p class="text-gray-500 text-sm">
            –í–∏–Ω–∏–∫–ª–∏ –ø–∏—Ç–∞–Ω–Ω—è? –ù–∞–ø–∏—à—ñ—Ç—å –Ω–∞–º —É 
            <a href="https://t.me/testlid12bot" class="text-blue-400 hover:underline">Telegram</a>
        </p>
        
    </div>
    
    <script>
        // –û—Ç—Ä–∏–º—É—î–º–æ orderReference –∑ URL –∞–±–æ localStorage
        const urlParams = new URLSearchParams(window.location.search);
        let orderReference = urlParams.get('orderReference');
        
        // –Ø–∫—â–æ –Ω–µ–º–∞—î –≤ URL - –±–µ—Ä–µ–º–æ –∑ localStorage
        if (!orderReference) {
            orderReference = localStorage.getItem('pending_order_id');
        }
        
        // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
        const SUPABASE_URL = 'https://jlwjocmcmrplvulqxnik.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impsd2pvY21jbXJwbHZ1bHF4bmlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyODY5NjgsImV4cCI6MjA4NTg2Mjk2OH0.5jbJRQVUJ2Hcle3bhq3LOtAtRpaHAd5_Slh44_h9apM';
        const BOT_USERNAME = 'testlid12bot';
        
        async function getTokenByOrderId(orderId) {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/payment_tokens?order_id=eq.${orderId}&select=token,status`,
                    {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        }
                    }
                );
                
                const data = await response.json();
                console.log('Token data:', data);
                
                if (data && data.length > 0 && data[0].status === 'unused') {
                    return data[0].token;
                }
                return null;
            } catch (error) {
                console.error('Error fetching token:', error);
                return null;
            }
        }
        
        async function init() {
            const loadingState = document.getElementById('loading-state');
            const botLinkContainer = document.getElementById('bot-link-container');
            const fallbackContainer = document.getElementById('fallback-container');
            const botLink = document.getElementById('bot-link');
            
            console.log('OrderReference:', orderReference);
            
            if (orderReference) {
                // –ß–µ–∫–∞—î–º–æ —Ç—Ä–æ—Ö–∏, –ø–æ–∫–∏ webhook —Å—Ç–≤–æ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω
                let token = null;
                let attempts = 0;
                const maxAttempts = 15;
                
                while (!token && attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    token = await getTokenByOrderId(orderReference);
                    attempts++;
                    console.log('Attempt', attempts, 'token:', token);
                }
                
                loadingState.classList.add('hidden');
                
                if (token) {
                    // –û—á–∏—â–∞—î–º–æ localStorage
                    localStorage.removeItem('pending_order_id');
                    
                    const link = `https://t.me/${BOT_USERNAME}?start=${token}`;
                    botLink.href = link;
                    botLinkContainer.classList.remove('hidden');
                } else {
                    fallbackContainer.classList.remove('hidden');
                }
            } else {
                // –ù–µ–º–∞—î orderReference - –ø–æ–∫–∞–∑—É—î–º–æ fallback
                loadingState.classList.add('hidden');
                fallbackContainer.classList.remove('hidden');
            }
        }
        
        // –ó–∞–ø—É—Å–∫–∞—î–º–æ
        init();
    </script>
    
</body>
</html>
